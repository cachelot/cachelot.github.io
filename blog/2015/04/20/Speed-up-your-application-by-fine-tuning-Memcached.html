<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Speed-up Your Application by Fine-tuning Memcached</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="description" content="Cachelot - high performance cache library and caching server" />
<meta name="keywords" content="Cachelot, cache, Memcached, distributed cache, high-performance, C++" />
<meta name="description" content="Memcached is often being threaten like a zero-configuration system. This isn&#39;t quite true.Proper adoption to the hardware and client applications behavio..." />
<link rel="canonical" href="http://www.cachelot.io/blog/2015/04/20/Speed-up-your-application-by-fine-tuning-Memcached.html">
<link rel="alternate" type="application/rss+xml" title="Cachelot" href="http://www.cachelot.io/feed.xml" />

<!-- favicon -->
<link rel="icon" type="image/png" href="/favicon96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicon16x16.png" sizes="16x16">
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
<link rel="icon" href="/favicon.ico" type="image/x-icon">

<!-- Font Awesome -->
<link href="/assets/css/font-awesome.min.css" rel="stylesheet">

<!-- Custom CSS -->
<link href="/assets/css/main.css" rel="stylesheet">

<!-- Fonts -->
<link href='http://fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Raleway:300,400,700' rel='stylesheet' type='text/css'>

<!-- Javascript -->
<script src="/assets/js/jquery.min.js"></script>
<script type="text/javascript" src="/assets/js/modernizr.custom.js"></script>

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<!-- Google analytics -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59820172-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>


</head>
<body data-spy="scroll" data-offset="0" data-target="#navbar-main">
  <div id="navbar-main"> 
    <!-- Fixed navbar -->
<div class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button>
      <a href="/index.html" class="navbar-brand smoothScroll"><span class="cachelot">cachelot</span><span class="io">.io</span></a>
    </div>
    <div class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right" id="nav">
        <li><a href="http://blog.cachelot.io">Blog</a></li>
        <li><a class="smoothScroll" href="/index.html#about">About</a></li>
        <li><a class="smoothScroll" href="/index.html#benchmarks">Benchmarks</a></li>
        <li><a class="smoothScroll" href="/index.html#status">Status</a></li>
        <li><a class="smoothScroll" href="/index.html#contact">Contact</a></li>
        <li><a href="/license.txt">License</a></li>
      </ul>
    </div>
    <!--/.nav-collapse --> 
  </div>
</div>

  </div>
  <div class="container">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-8 col-md-offset-2 col-xs-12 post">
<!-- Header -->
      <header class="post-header centered">
        <h1 class="post-title">Speed-up Your Application by Fine-tuning Memcached</h1>
        <p class="post-meta">Apr 20, 2015</p>
        <img class="title-image" src="/assets/img/blog/fine-tuning-memcached.jpg" alt="Speed-up Your Application by Fine-tuning Memcached" />
      </header>
<!-- Content -->
      <article class="post-content">
        <p>Memcached is often being threaten like a zero-configuration system. This isn&#39;t quite true.
Proper adoption to the hardware and client applications behavior can significantly improve overall performance.</p>

<p>Memcached is pretty simple, and there is a handful of statistics. You only need to know a bit of internals to use it. 
Luckily, it&#39;s not a complicated thing at all.</p>

<p>As usual, there is no silver bullet. You&#39;re free to experiment. I even encourage you to do this.</p>

<h2>Stats</h2>

<p>The starting point of performance tuning is the stats. The easiest way to see stats is to connect to the Memcached server with telnet and run <code>stats</code> in the telnet console.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ telnet localhost 11211
Connected to localhost.
Escape character is &#39;^]&#39;.
telnet&gt; stats

STAT pid 12950
STAT uptime 55
STAT time 1429483226
STAT version 1.4.15
STAT libevent 2.0.21-stable
STAT pointer_size 64
STAT rusage_user 4.758163
STAT rusage_system 8.206732
STAT curr_connections 10
STAT total_connections 123
STAT connection_structures 42
STAT reserved_fds 20
...
</code></pre></div>
<h3>Command Hits / Misses</h3>

<p>There are number of hits/misses stats for every command, and these can reveal problems in application behavior. 
For instance, an application may aggressively cache short-living or rarely used objects, causing a hight rate of misses and evictions. 
The rule of thumb here is to keep the cache miss ratio close to zero.</p>

<h3>Evictions</h3>

<p>One of the most important stats is <code>evictions</code>. It is the number of non-expired Items that were removed from the cache to free up space for new items.</p>

<p>A high number of evictions may indicate that applications overuse the cache or that the amount of memory allocated for Items storage is not sufficient. 
The maximum amount of memory used to store Items can be increased by the -m command-line argument (default value is 64Mb).</p>

<h3>Connection Yields</h3>

<p>The number of times when a connection was yielded during batch execution.</p>

<p>The slowest part of the request execution is the network roundtrip. The application should use batching to achieve maximum performance. 
Several write requests can be combined into a single network IO operation. Read operations should utilize multi-key requests.</p>

<p>The downside of using batches is possible connection starvation - the situation when one connection is forced to wait until another finishes its batch. Memcached limits the number of requests per single network IO operation to prevent starvation. Every time a connection tries to execute a batch bigger than this limit; Memcached moves this connection to the back of the processing queue and increments the <code>conn_yields</code> stat.</p>

<p>The command-line parameter <code>-R</code> is in charge of the maximum number of requests per network IO event (default value is 20). The application should adopt its batch size according to this parameter. Please note that the requests limit does not affect multi-key reads, or the number of keys per get request.</p>

<h2>Other Command-line Arguments</h2>

<h3>Number of threads</h3>

<p>The most important setting influenced overall performance: number of threads <code>-t</code>. The default value of 4 is a good choice for almost every setup.
Avoid using more than eight threads, it leads to high lock contention inside of Memcached and performance degrade.</p>

<p>A configuration with a single thread should never be used, even on a single-core machine.</p>

<h3>Disable use of CAS</h3>

<p>A compare-and-swap operation of Memcached requires a separate Item field to store unique CAS values. It takes an additional 8 bytes of memory per Item.
If CAS operation is not used by your application, <code>-C</code> flag can save some memory.</p>

<h3>Memcached as In-memory Storage</h3>

<p>There is <code>-M</code> argument that tells Memcached to reply with an error when out-of-memory instead of evicting existing items.
In that way, it&#39;s possible to use Memcached as a consistent in-memory storage.</p>

<h2>General Advices</h2>

<p>Use the pool of long-living connections to the server. Memcached is designed to serve many connections simultaneously and with tens of connections you will achieve much better performance.</p>

<p>Store Items over TCP, retrieve over UDP. As was said: the network transportation is a main source of delays. On a high data volume, TCP packet size overhead can significantly impact overall performance.</p>

<h4><em>Share your Memcached tips in the comments.</em></h4>

      </article>
    </div>
  </div> <!-- row -->
  <div class="row text-right">
    <div class="col-lg-8 col-lg-offset-2 col-xs-12">
<!-- Share in social networks -->
      <ul class="share-buttons">
        <!-- Google+ -->
        <li><div class="g-plus" data-action="share" data-annotation="bubble"></div></li>
        <!-- Facebook -->
        <li><div class="fb-share-button" data-href="/blog/2015/04/20/Speed-up-your-application-by-fine-tuning-Memcached.html" data-layout="button_count"></div></li>
        <!-- Twitter -->
        <li><a href="https://twitter.com/share" class="twitter-share-button" data-via="cachelot_io">Tweet</a></li>
      </ul>
    </div>
  </div> <!-- row -->
<!-- Disqus -->
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-xs-12">
      <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
    </div>  
  </div> <!-- row -->
</div>

<!-- scripts section -->

  <!-- Facebook -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
  <!-- Twitter --->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <!-- Google+ -->
<script src="https://apis.google.com/js/platform.js" async defer></script>
  <!-- Disqus -->
<script type="text/javascript">
  var disqus_shortname = 'cachelot';
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


  <!-- ==== FOOTER ==== -->
<div id="footerwrap">
  <div class="container">
    <div class="row centered" id="contact">
      <div class="col-xs-12">
        <ul class="social">
          <li>
            <a href="/feed.xml"><i class="fa fa-rss"></i></a>
          </li>
          <li>
            <a href="https://twitter.com/cachelot_io"><i class="fa fa-twitter"></i></a>
          </li>
          <li>
            <a href="https://facebook.com/cachelot.io"><i class="fa fa-facebook"></i></a>
          </li>
          <li>
            <a href="https://plus.google.com/+CachelotIo_cache"><i class="fa fa-google-plus"></i></a>
          </li>
          <li>
            <a href="https://bitbucket.org/cachelot/cachelot"><i class="fa fa-bitbucket"></i></a>
          </li>
          <li>
            <a href="https://github.com/cachelot/cachelot"><i class="fa fa-github"></i></a>
          </li>
        </ul>
      </div>
    </div>
    <div class="row">
      <div class="col-md-12 centered"> 
        <span class="copyright">Copyright &copy; 2015 <a href="#home">www.cachelot.io</a>. 
                                Logo design by <a href="https://www.behance.net/arttolstykh">arttolstykh</a>.
                                Hosted on <a href="https://pages.github.com/">GitHub Pages</a></span> 
      </div>
    </div> <!-- row -->
  </div>
</div>

<!-- Bootstrap core JavaScript
    ================================================== --> 
<!-- Placed at the end of the document so the pages load faster --> 

<script type="text/javascript" src="/assets/js/bootstrap.min.js"></script> 
<script type="text/javascript" src="/assets/js/retina.js"></script> 
<script type="text/javascript" src="/assets/js/jquery.easing.1.3.js"></script> 
<script type="text/javascript" src="/assets/js/smoothscroll.js"></script> 
<script type="text/javascript" src="/assets/js/jquery-func.js"></script>

</body>
</html>
